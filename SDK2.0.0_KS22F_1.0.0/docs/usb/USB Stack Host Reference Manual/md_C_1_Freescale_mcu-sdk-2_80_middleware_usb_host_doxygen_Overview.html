<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.4"/>
<title>USB Stack Host Reference Manual: Overview</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="fs_logo.gif"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">USB Stack Host Reference Manual
   &#160;<span id="projectnumber">Rev. 0</span>
   </div>
   <div id="projectbrief">Freescale Semiconductor, Inc.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.4 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>API&#160;Reference</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('md_C_1_Freescale_mcu-sdk-2_80_middleware_usb_host_doxygen_Overview.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Overview </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The USB host stack is composed of USB class drivers, USB common host driver and USB controller driver which consist of xHCI driver. Please be noted that the xHCI represent EHCI or KHCI, not the XHCI for USB 3.0. <br/>
 To support different RTOSes with the same code base, the OSA is used inside the USB stack to wrap the differences between RTOSes. Please note the OSA is not supported to be used in the USB application, so from USB application’s view point, the OSA is invisible. <br/>
 And the USB host stack must work with a dedicated application in which the following tasks should be done:</p>
<ul>
<li>Configure USB clock</li>
<li>Initialize/configure the USB host stack</li>
<li>Choose the proper configuration when one peripheral is connected on callback event received and decide if one peripheral could be supported by this application</li>
<li>Initialize class</li>
<li>Choose the proper interface setting and configure the peripheral if needed</li>
<li>Initialize the transfer request</li>
<li>Handle the transfer result through the callback <br/>
 The whole architecture and components of USB host stack is as below:</li>
</ul>
<div class="image">
<img src="host_stack_architecture.jpg" alt="host_stack_architecture.jpg"/>
</div>
 <p>The interface between KHCI/EHCI Driver and Common Controller driver is internal and will be simply discussed in this document.</p>
<h1><a class="anchor" id="USBHostInitFlow"></a>
USB Host Initialization flow</h1>
<p>For the whole view the host stack works as follow:</p>
<div class="image">
<img src="host_stack_whole_flow.jpg" alt="host_stack_whole_flow.jpg"/>
</div>
 <p>Host stack initialization flow is as follow:</p>
<div class="image">
<img src="host_stack_initialization_flow.jpg" alt="host_stack_initialization_flow.jpg"/>
</div>
  <pre class="fragment">- If the platform use one GPIO to control the VBUS, initialize the GPIO and output high.
- Initialize USB host clock.
- Call USB_HostInit to initialize usb host stack.
- Set the USB interrupt priority and Enable the interrupt.
- Create host task with the task API USB_HostkhciTaskFunction or USB_HostEhciTaskFunction, create application task if necessary.
</pre><h1><a class="anchor" id="USBHostEventFlow"></a>
USB Host peripheral attach/detach flow</h1>
<p>The peripheral attach/detach/unsupported event notify application through the callback function that is registered by USB_HostInit. <br/>
 The peripheral attach/detach flow is as follow:</p>
<div class="image">
<img src="host_stack_attach_flow.jpg" alt="host_stack_attach_flow.jpg"/>
</div>
 <p>The parameters of the callback contain the device handle, configuration handle, and event code. The key point is the configuration handle, all the interfaces’ information within this configuration is included. The application should take use of the information to decide if this configuration is supported. Please note that if APP return kStatus_USB_NotSupported, the USB host stack will check the next configuration descriptor of the peripheral until the APP return kStatus_USB_Success or all the configuration descriptors are checked. If there is no supported configuration found in the peripheral’s descriptor, the kUSB_HostEventNotSupported event will be notified to application through callback function registered by usb_host_init.</p>
<p>There are four events in the callback, please reference to host_event_t:</p>
<ul>
<li>kUSB_HostEventAttach for peripheral attach;</li>
<li>kUSB_HostEventDetach for unsupported peripheral attach;</li>
<li>kUSB_HostEventEnumerationDone for supported peripheral enumeration done;</li>
<li>kUSB_HostEventNotSupported for peripheral detach.</li>
</ul>
<p>For examples:</p>
<ul>
<li>case 1: the device has one configuration and is supported by host application. the event flow is as follow:<ul>
<li>(1) kUSB_HostEventAttach event, application judge the configuration and return kStatus_USB_Success.</li>
<li>(2) kUSB_HostEventEnumerationDone event, application start to initialize class and run.</li>
</ul>
</li>
<li>case 2: the device has two configuration and is not supported by host applicaiton, the evetn flow is as follow:<ul>
<li>(1) kUSB_HostEventAttach event, application judge the first configuration and return kStatus_USB_NotSupported.</li>
<li>(2) kUSB_HostEventAttach event, application judge the second configuration and return kStatus_USB_NotSupported.</li>
<li>(3) kUSB_HostEventNotSupported event, application print device not supported information. </li>
</ul>
</li>
</ul>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.5-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul class="foot">
    <li class="footer">Tue Dec 15 2015 &copy; 2015 Freescale Semiconductor, Inc. All rights reserved.
    </li>
  </ul>
</div>
</body>
</html>
