<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>USB Stack Device Reference Manual: Overview</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="fs_logo.gif"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">USB Stack Device Reference Manual
   &#160;<span id="projectnumber">Rev. 0</span>
   </div>
   <div id="projectbrief">Freescale Semiconductor, Inc.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>API&#160;Reference</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('md_C_1_Users_b45786_Documents_mcu-sdk-2_80_middleware_usb_device_doxygen_Overview.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Overview </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The USB device stack is composed of USB controller driver only which consist of the common controller driver and xHCI driver. The device class driver and the USB framework to handle the standard enumeration and request defined by USB spec 2.0 are moved to the application layer, these two parts are examples specific so the footprint of the example can be reduced. </p>
<dl class="section note"><dt>Note</dt><dd>Please be noted that the xHCI represent EHCI or KHCI, not the XHCI for USB 3.0.</dd></dl>
<p><br/>
 In the USB Device stack, we will have two different USB applications, one is the lite version and another is very similar with the examples in the previous USB stack. <br/>
 The whole architecture and components of USB stack as below:</p>
<div class="image">
<img src="usb_device_stack_architecture.jpg" alt="usb_device_stack_architecture.jpg"/>
</div>
 <p><br/>
 For the lite version application, the code size would be much less than the non-lite version. But an obvious drawback of this new architecture is now the customer needs to use the controller driver API to implement the standard enumeration process, the class specific process and the customer’s owner specific functionality by themselves. For some customers who have little USB knowledge, this is hard task. <br/>
 The device stack initialization sequence for lite version application is as follows:</p>
<ol type="1">
<li>Initialize the Pin Mux, USB clock, etc. If the SOC has USB KHCI dedicated RAM, the RAM memory needs to be clear after the KHCI clock is enabled. When the demo uses USB EHCI IP, the USB KHCI dedicated RAM can not be used and the memory can't be accessed.</li>
<li>Initialize the USB device stack by calling API <a class="el" href="group__usb__device__driver.html#ga8fc2eafa1142f904576bbd697d785184" title="Initialize the USB device stack. ">USB_DeviceInit</a>.</li>
<li>When the device task enabled, create the USB device task by using the device handle, returned from <a class="el" href="group__usb__device__driver.html#ga8fc2eafa1142f904576bbd697d785184" title="Initialize the USB device stack. ">USB_DeviceInit</a>, as the task parameter when the environment is RTOS.</li>
<li>Install the USB ISR.</li>
<li>Enable the USB interrupt and the interrupt priority.</li>
<li>Start the USB device by calling <a class="el" href="group__usb__device__driver.html#gaecab79f44d7c16d5344aef538ddfa40e" title="Enable the device functionality. ">USB_DeviceRun</a>.</li>
</ol>
<div class="image">
<img src="usb_device_initialization_lite.jpg" alt="usb_device_initialization_lite.jpg"/>
</div>
 <p><br/>
 To assist the customer who has less concerns about the footprint and focus on ease of use perspective of the USB stack, a generic usb_ch9 implementation is provided, as well as the specified class driver like HID class driver, CDC class driver, etc. This implementation is more generic so they can be re-used in different examples and the APIs are easier to use. But some callback functions need to be implemented and the code size would be bigger. <br/>
 The device stack initialization sequence for non-lite version application is as follows:</p>
<ol type="1">
<li>Initialize the Pin Mux, USB clock, etc. If the SOC has USB KHCI dedicated RAM, the RAM memory needs to be clear after the KHCI clock is enabled. When the demo uses USB EHCI IP, the USB KHCI dedicated RAM can not be used and the memory can't be accessed.</li>
<li>Initialize the USB device stack by calling API <a class="el" href="group__usb__device__class__driver.html#ga60d8c2d8d7c81a419383ce2776eec1db" title="Initialize the common class and the supported classes. ">USB_DeviceClassInit</a>, and initialize each application.</li>
<li>Get each class handle from <a class="el" href="group__usb__device__class__driver.html#ae57d06d7d8304ca97c6d921c3279c87b" title="the class handle of the class, filled by the common driver. ">usb_device_class_config_struct_t::classHandle</a>.</li>
<li>When the device task enabled, create the USB device task by using the device handle, returned from <a class="el" href="group__usb__device__class__driver.html#ga60d8c2d8d7c81a419383ce2776eec1db" title="Initialize the common class and the supported classes. ">USB_DeviceClassInit</a>, as the task parameter when the environment is RTOS.</li>
<li>Install the USB ISR.</li>
<li>Enable the USB interrupt and the interrupt priority.</li>
<li>Start the USB device by calling <a class="el" href="group__usb__device__driver.html#gaecab79f44d7c16d5344aef538ddfa40e" title="Enable the device functionality. ">USB_DeviceRun</a>.</li>
</ol>
<div class="image">
<img src="usb_device_initialization_none_lite.jpg" alt="usb_device_initialization_none_lite.jpg"/>
</div>
 <p><br/>
 To support different RTOS with the same code base, the OSA is used inside the USB stack to wrap the differences between RTOSes. </p>
<dl class="section note"><dt>Note</dt><dd>The OSA is not supposed to be used in the USB application, so from USB applications’ viewpoint, the OSA is invisible.</dd></dl>
<h1><a class="anchor" id="USBDeviceCallbackWorkingFlow"></a>
USB Device Callback Working Flow</h1>
<p>The device callback is registered when <a class="el" href="group__usb__device__driver.html#ga8fc2eafa1142f904576bbd697d785184" title="Initialize the USB device stack. ">USB_DeviceInit</a> function called. <br/>
 The following events should be processed in this callback function:</p>
<ul>
<li>kUsbDeviceEventBusReset <br/>
 When the application receives this event, it means the device received a BUS RESET signal. In the event, control pipe should be initialized, please refer to the working flow. And the parameter eventParam is not used.</li>
<li>kUsbDeviceEventSetConfiguration <br/>
 When the application receives this event, it means the host sent a set configuration request. The configuration value can be got from the parameter eventParam. In the event, the application’s configure can be set. And initialize each interface in current configuration by using zero as the alternate setting.</li>
<li>kUsbDeviceEventSetInterface <br/>
 When the application receives this event, it means the host sent a set alternate setting request of an interface. The interface and alternate setting value can be got from the parameter eventParam. The eventParam points to a uint16_t variable. The high 8-bit is interface value, and the low 8-bit is alternate setting. In the event, the application changes the alternate setting of this interface if the new alternate setting is not equal to current. <br/>
 Normally, the change step as follows: <br/>
 1. Cancel all transfers of current alternate setting in this interface. <br/>
 2. De-initialize all pipes of current alternate setting in this interface. <br/>
 3. Initialize all pipes of new alternate setting in this interface. <br/>
 4. Prime the transfers of new setting. <br/>
 For example, <div class="fragment"><div class="line">uint16_t*   temp16 = (uint16_t*)eventParam;</div>
<div class="line">uint8_t       <span class="keyword">interface </span>= (uint8_t)((*temp16&amp;0xFF)&gt;&gt;0x08);</div>
<div class="line">currentAlternateSetting[interface] = (uint8_t)(*temp16&amp;0xFF);</div>
</div><!-- fragment --> <br/>
 The device callback event working flow:</li>
</ul>
<div class="image">
<img src="usb_device_callback_working_flow.jpg" alt="usb_device_callback_working_flow.jpg"/>
</div>
  </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.5-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul class="foot">
    <li class="footer">Mon Dec 14 2015 &copy; 2015 Freescale Semiconductor, Inc. All rights reserved.
    </li>
  </ul>
</div>
</body>
</html>
